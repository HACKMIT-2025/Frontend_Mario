<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Mario Game - Play</title>
    <style>
      /* 完整游戏页面样式 */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html, body {
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        font-family: 'Arial', sans-serif;
        overflow-x: hidden;
        /* 移动设备优化 */
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        touch-action: manipulation;
      }

      .header {
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      }

      .header h1 {
        font-size: 24px;
        font-weight: bold;
      }

      .header-actions {
        display: flex;
        gap: 10px;
      }

      .btn {
        background: #4CAF50;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.3s;
      }

      .btn:hover {
        background: #45a049;
      }

      .btn.secondary {
        background: #2196F3;
      }

      .btn.secondary:hover {
        background: #1976D2;
      }

      .btn.danger {
        background: #f44336;
      }

      .btn.danger:hover {
        background: #d32f2f;
      }

      #app {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      .game-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
        gap: 12px;
      }

      #game-container {
        position: relative;
        width: 1024px;
        height: 576px;
        background: #000;
        border-radius: 10px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        overflow: hidden;
        border: 3px solid #333;
        /* 确保在小屏幕上仍能正常显示 */
        max-width: calc(100vw - 40px);
        max-height: calc(100vh - 250px);
      }

      #game-canvas {
        display: block;
        width: 1024px;
        height: 576px;
        /* 如果容器被缩小，按比例缩放整个画布 */
        max-width: 100%;
        max-height: 100%;
      }

      #game-ui {
        position: relative;
        z-index: 100;
        background: linear-gradient(45deg, rgba(0,0,0,0.8), rgba(0,0,0,0.6));
        padding: 12px 20px;
        border-radius: 10px;
        color: white;
        font-weight: bold;
        font-size: 16px;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        border: 1px solid rgba(255,255,255,0.2);
        display: flex;
        gap: 20px;
        backdrop-filter: blur(8px);
        width: fit-content;
      }

      #game-ui div {
        margin: 0;
      }

      #game-ui div:last-child {
        margin-bottom: 0;
      }

      .num_deaths, .elapsed_time, .coins {
        background: rgba(0,0,0,0.4);
        padding: 5px 12px;
        border-radius: 6px;
        display: inline-block;
      }

      /* Loading Status */
      #loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        z-index: 200;
        color: white;
        font-size: 18px;
      }

      .spinner {
        border: 4px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top: 4px solid white;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* 移动设备优化 */
      .mobile-controls {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1001;
        display: none;
      }

      .mobile-btn {
        display: block;
        margin-bottom: 5px;
        padding: 8px 12px;
        background: rgba(0,0,0,0.7);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        min-width: 100px;
      }

      .mobile-btn:hover {
        background: rgba(0,0,0,0.9);
      }

      @media screen and (max-width: 768px) {
        .header {
          padding: 8px 12px;
        }

        .header h1 {
          font-size: 18px;
        }

        .header-actions {
          gap: 5px;
        }

        .btn {
          padding: 6px 10px;
          font-size: 12px;
        }

        .game-section {
          padding: 10px;
          gap: 8px;
        }

        #game-container {
          /* 在移动设备上保持固定尺寸，但允许适当缩放以适应屏幕 */
          max-width: calc(100vw - 20px);
          max-height: calc(100vh - 200px);
          border: 2px solid #333;
          border-radius: 6px;
        }

        .mobile-controls {
          display: block;
        }

        #game-ui {
          font-size: 12px;
          padding: 8px 14px;
          gap: 12px;
        }
      }

      @media screen and (orientation: landscape) and (max-height: 500px) {
        .header {
          padding: 4px 8px;
        }

        .header h1 {
          font-size: 16px;
        }

        .game-section {
          padding: 5px;
          gap: 4px;
        }

        #game-container {
          /* 横屏模式下保持固定尺寸 */
          max-width: calc(100vw - 10px);
          max-height: calc(100vh - 140px);
        }

        #game-ui {
          font-size: 11px;
          padding: 6px 12px;
          gap: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <!-- Top Navigation -->
      <header class="header">
        <h1>🍄 Mario Game</h1>
        <div class="header-actions">
          <button class="btn secondary" onclick="shareGame()">📤 Share Game</button>
          <button class="btn" onclick="restartGame()">🔄 Restart</button>
          <button class="btn danger" onclick="goHome()">🏠 Home</button>
        </div>
      </header>

      <!-- 移动控制 -->
      <div class="mobile-controls">
        <button class="mobile-btn" onclick="toggleVirtualGamepad()">🎮 Controls</button>
        <button class="mobile-btn" onclick="toggleVibration()">📳 Vibration</button>
        <button class="mobile-btn" onclick="showHelp()">❓ Help</button>
      </div>

      <!-- Game Area -->
      <main class="game-section">
        <!-- Game UI above container -->
        <div id="game-ui">
          <div class="num_deaths">Deaths: <span id="num_deaths">0</span></div>
          <div class="elapsed_time">Time: <span id="elapsed_time">0</span></div>
          <div class="coins">Coins: <span id="coins">0</span></div>
        </div>

        <div id="game-container">
          <canvas id="game-canvas"></canvas>

          <!-- Loading Status -->
          <div id="loading">
            <div class="spinner"></div>
            <div>Loading game...</div>
          </div>

        </div>
      </main>

    </div>

    <script>
      let gameAPI = null

      function restartGame() {
        if (gameAPI) {
          gameAPI.resetGame()
        }
      }

      function shareGame() {
        const url = window.location.href
        navigator.clipboard.writeText(url).then(() => {
          alert('Game link copied to clipboard!')
        }).catch(() => {
          prompt('Please copy the game link manually:', url)
        })
      }

      function goHome() {
        if (confirm('Are you sure you want to leave the current game?')) {
          window.location.href = '/'
        }
      }

      // 移动设备支持函数
      function toggleVirtualGamepad() {
        if (window.MarioGameAPI && window.MarioGameAPI.getEngine) {
          const inputManager = window.MarioGameAPI.getEngine().getInputManager()
          if (inputManager) {
            inputManager.toggleVirtualGamepad()
          }
        }
      }

      function toggleVibration() {
        if (window.MarioGameAPI && window.MarioGameAPI.getEngine) {
          const inputManager = window.MarioGameAPI.getEngine().getInputManager()
          if (inputManager) {
            window.vibrationEnabled = !window.vibrationEnabled
            inputManager.setVibrationEnabled(window.vibrationEnabled)
            alert(window.vibrationEnabled ? 'Vibration ON' : 'Vibration OFF')
          }
        }
      }

      function showHelp() {
        alert('🎮 Controls:\n\n⬅️➡️ Arrow Keys - Move\n⬆️ Space - Jump\n⚡ Shift - Run\n📱 Touch the virtual buttons on mobile devices')
      }

      // 初始化震动状态
      window.vibrationEnabled = true

      console.log('🎮 Mario Game - Play Mode Initialized')
    </script>

    <script type="module" src="/src/play.ts"></script>
  </body>
</html>